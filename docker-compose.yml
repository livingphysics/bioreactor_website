version: '3.8'

services:
  # Web Server - User interface
  web-server:
    build: ./web-server
    ports:
      - "3000:3000"
    environment:
      - BIOREACTOR_HUB_API_URL=http://bioreactor-hub:8000
      - BIOREACTOR_NODE_API_URL=http://bioreactor-node:9000
    depends_on:
      - bioreactor-hub
    volumes:
      - ./web-server/uploads_tmp:/app/uploads_tmp
      - ./web-server/config:/app/config
      - ./bioreactor-node-v3/data:/app/node_data:ro  # Read-only access to experiment data
    networks:
      - bioreactor-network

  # Bioreactor Hub - Experiment forwarding service
  bioreactor-hub:
    build: ./bioreactor-hub
    ports:
      - "8000:8000"
    environment:
      - BIOREACTOR_NODE_API_URL=http://bioreactor-node:9000
    depends_on:
      - bioreactor-node
    volumes:
      - ./bioreactor-hub/data:/app/data
    networks:
      - bioreactor-network

  # Bioreactor Node v3 - Modular hardware interface with v2 compatibility
  bioreactor-node:
    build: ./bioreactor-node-v3
    container_name: bioreactor-node-v3
    ports:
      - "9000:9000"
    environment:
      - HARDWARE_MODE=real  # Set to "real" for physical hardware
      - LOG_LEVEL=INFO
      - HOST_DATA_PATH=/home/david/Documents/GitHub/bioreactor_website/bioreactor-node-v3/data
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./bioreactor-node-v3/data:/app/data
      - /dev/gpiochip4:/dev/gpiochip4  # Pi 5 GPIO (only for real mode)
      - /dev/i2c-1:/dev/i2c-1  # I2C bus for CO2 sensor
    privileged: true  # Required for Docker-in-Docker and GPIO access
    networks:
      - bioreactor-network

volumes:
  experiment-data:

networks:
  bioreactor-network:
    driver: bridge 
